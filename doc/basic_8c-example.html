<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mir: basic.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Mir
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">basic.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>A simple mir client </p>
<h1><a class="anchor" id="MirDemoState"></a>
MirDemoState</h1>
<p>The handles needs to be accessible both to callbacks and to the control function. </p><div class="fragment"><div class="line"><span class="comment">// Utility structure for the state of a single surface session.</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a name="a0"></a><a class="code" href="basic_8c.html#ab12d2092e33dd10fed15d4ed23f5c572">MirDemoState</a></div><div class="line">{</div><div class="line">    <a class="code" href="group__mir__toolkit.html#gad3936156a02cd24658178bca6be4bd9e">MirConnection</a> *connection;</div><div class="line">    <a class="code" href="group__mir__toolkit.html#ga4f71f6d4ba268c6a48a2fbcc7b9938e5">MirWindow</a>* window;</div><div class="line">} <a class="code" href="basic_8c.html#ab12d2092e33dd10fed15d4ed23f5c572">MirDemoState</a>;</div></div><!-- fragment --> <div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Copyright Â© 2012 Canonical Ltd.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This program is free software: you can redistribute it and/or modify</span></div><div class="line"><span class="comment"> * it under the terms of the GNU General Public License version 2 or 3 as</span></div><div class="line"><span class="comment"> * published by the Free Software Foundation.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This program is distributed in the hope that it will be useful,</span></div><div class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><span class="comment"> * GNU General Public License for more details.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></div><div class="line"><span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Authored by: Alan Griffiths &lt;alan@octopull.co.uk&gt;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="mir__client__library_8h.html">mir_toolkit/mir_client_library.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="graphics__module_8h.html">mir_toolkit/extensions/graphics_module.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Utility structure for the state of a single surface session.</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="basic_8c.html#ab12d2092e33dd10fed15d4ed23f5c572">MirDemoState</a></div><div class="line">{</div><div class="line">    <a class="code" href="group__mir__toolkit.html#gad3936156a02cd24658178bca6be4bd9e">MirConnection</a> *connection;</div><div class="line">    <a class="code" href="group__mir__toolkit.html#ga4f71f6d4ba268c6a48a2fbcc7b9938e5">MirWindow</a>* window;</div><div class="line">} <a class="code" href="basic_8c.html#ab12d2092e33dd10fed15d4ed23f5c572">MirDemoState</a>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a1"></a><a class="code" href="basic_8c.html#ab8531ab282a4e7c02c77e120fe652b2f">demo_client</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* server, <span class="keywordtype">int</span> buffer_swap_count)</div><div class="line">{</div><div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> <span class="keyword">const</span> <a name="a2"></a><a class="code" href="mir__image_8h.html#aca34d28e3d8bcbcadb8edb4e3af24f8c">width</a> = 640;</div><div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> <span class="keyword">const</span> <a name="a3"></a><a class="code" href="mir__image_8h.html#ab2e78c61905b4419fcc7b4cfc500fe85">height</a> = 480;</div><div class="line"></div><div class="line">    <a class="code" href="basic_8c.html#ab12d2092e33dd10fed15d4ed23f5c572">MirDemoState</a> mcd;</div><div class="line">    mcd.connection = 0;</div><div class="line">    mcd.window = 0;</div><div class="line"></div><div class="line">    puts(<span class="stringliteral">&quot;Starting&quot;</span>);</div><div class="line"></div><div class="line">    mcd.connection = <a name="a4"></a><a class="code" href="group__mir__toolkit.html#gaf8c65b7597fc560616747cf259dcc045">mir_connect_sync</a>(server, __FILE__);</div><div class="line">    puts(<span class="stringliteral">&quot;Connected&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (mcd.connection == NULL || !<a name="a5"></a><a class="code" href="group__mir__toolkit.html#ga5dad61d745ee5707f7a143c6732c9e46">mir_connection_is_valid</a>(mcd.connection))</div><div class="line">    {</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *<a name="a6"></a><a class="code" href="namespacemir_1_1dispatch.html#a1193057c5af0cf923bb4090e7baad1cfa8fafb02ca3c9ad270f620b56400b8b5b">error</a> = <span class="stringliteral">&quot;Unknown error&quot;</span>;</div><div class="line">        <span class="keywordflow">if</span> (mcd.connection != NULL)</div><div class="line">            error = <a name="a7"></a><a class="code" href="group__mir__toolkit.html#ga0c4ee044830aacb0770e0823031e3ea1">mir_connection_get_error_message</a>(mcd.connection);</div><div class="line"></div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to connect to server `%s&#39;: %s\n&quot;</span>,</div><div class="line">                server == NULL ? <span class="stringliteral">&quot;&lt;default&gt;&quot;</span> : server, error);</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">        <a name="_a8"></a><a class="code" href="struct_mir_module_properties.html">MirModuleProperties</a> properties = { NULL, -1, -1, -1, NULL };</div><div class="line"></div><div class="line">        <a name="_a9"></a><a class="code" href="struct_mir_extension_graphics_module_v1.html">MirExtensionGraphicsModuleV1</a> <span class="keyword">const</span>* ext = mir_extension_graphics_module_v1(mcd.connection);</div><div class="line">        assert(ext);</div><div class="line"></div><div class="line">        ext-&gt;<a name="a10"></a><a class="code" href="struct_mir_extension_graphics_module_v1.html#a7dac3e55dd91b2a9b4e178a76806bce5">graphics_module</a>(mcd.connection, &amp;properties);</div><div class="line"></div><div class="line">        assert(NULL != properties.<a name="a11"></a><a class="code" href="struct_mir_module_properties.html#a29f86cc3d3b32a81204180bacfa5d20f">name</a>);</div><div class="line">        assert(0 &lt;= properties.<a name="a12"></a><a class="code" href="struct_mir_module_properties.html#a79fb0a39ba3a20c59237c992504f271c">major_version</a>);</div><div class="line">        assert(0 &lt;= properties.<a name="a13"></a><a class="code" href="struct_mir_module_properties.html#aed903e8b426984486fa72a48b4bc2687">minor_version</a>);</div><div class="line">        assert(0 &lt;= properties.<a name="a14"></a><a class="code" href="struct_mir_module_properties.html#ac3e825762a22330869bcf0c6a8656a53">micro_version</a>);</div><div class="line">        assert(NULL != properties.<a name="a15"></a><a class="code" href="struct_mir_module_properties.html#a020abad44645ba87e0060f41caf7f4c8">filename</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Identify a supported pixel format</span></div><div class="line">    <a class="code" href="group__mir__toolkit.html#gaab034964866decf1eee6f624c9009714">MirPixelFormat</a> <a name="a16"></a><a class="code" href="client__types_8h.html#aa19d739158cce5b1af3ed0b07fcc69fb">pixel_format</a> = <a name="a17"></a><a class="code" href="group__mir__toolkit.html#ggaab034964866decf1eee6f624c9009714a320cf4331589c754dc96d1d2b00ecb50">mir_pixel_format_invalid</a>;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> valid_formats;</div><div class="line">    <a name="a18"></a><a class="code" href="group__mir__toolkit.html#ga7271df452287f580ef6febd914a56c12">mir_connection_get_available_surface_formats</a>(mcd.connection, &amp;pixel_format, 1, &amp;valid_formats);</div><div class="line"></div><div class="line">    <a name="_a19"></a><a class="code" href="class_mir_render_surface.html">MirRenderSurface</a>* rs = <a name="a20"></a><a class="code" href="group__mir__toolkit.html#ga4ec86fbe6e7b3cbd231f28a02197ee94">mir_connection_create_render_surface_sync</a>(mcd.connection, width, height);</div><div class="line">    <a class="code" href="group__mir__toolkit.html#ga9a5a3e18322b4de6cef9bf3ccb43f508">MirWindowSpec</a> *spec = <a name="a21"></a><a class="code" href="group__mir__toolkit.html#ga1d3da50b5413b79131a42f29d14a8954">mir_create_normal_window_spec</a>(mcd.connection, width, height);</div><div class="line">    assert(spec != NULL);</div><div class="line">    <a name="a22"></a><a class="code" href="group__mir__toolkit.html#gaad9c2d154b133890878f285460ad13ac">mir_window_spec_set_name</a>(spec, __FILE__);</div><div class="line">    <a name="a23"></a><a class="code" href="group__mir__toolkit.html#ga6b6228f0a013a2f20c4ff12f3d554554">mir_window_spec_add_render_surface</a>(spec, rs, width, height, 0, 0);</div><div class="line"></div><div class="line">    <span class="comment">// ...we create a surface using that format.</span></div><div class="line">    mcd.window = <a name="a24"></a><a class="code" href="group__mir__toolkit.html#ga99732d590331951204634d1f78a5c07e">mir_create_window_sync</a>(spec);</div><div class="line">    puts(<span class="stringliteral">&quot;Window created&quot;</span>);</div><div class="line"></div><div class="line">    <a name="a25"></a><a class="code" href="group__mir__toolkit.html#ga8c494d79b6875aa8bb1a8570e9b88078">mir_window_spec_release</a>(spec);</div><div class="line"></div><div class="line">    <span class="comment">// We expect a surface handle;</span></div><div class="line">    <span class="comment">// we expect it to be valid; and,</span></div><div class="line">    <span class="comment">// we don&#39;t expect an error description</span></div><div class="line">    assert(mcd.window != NULL);</div><div class="line">    <span class="keywordflow">if</span> (!<a name="a26"></a><a class="code" href="group__mir__toolkit.html#ga3e64bebc2748eb7deed30130cc111783">mir_window_is_valid</a>(mcd.window))</div><div class="line">    {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to create surface: %s&quot;</span>,</div><div class="line">        <a name="a27"></a><a class="code" href="group__mir__toolkit.html#gaa8121b859ab4723ad1c6de9462dcfd76">mir_window_get_error_message</a>(mcd.window));</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        assert(strcmp(<a class="code" href="group__mir__toolkit.html#gaa8121b859ab4723ad1c6de9462dcfd76">mir_window_get_error_message</a>(mcd.window), <span class="stringliteral">&quot;&quot;</span>) == 0);</div><div class="line"></div><div class="line">    <a name="_a28"></a><a class="code" href="struct_mir_buffer_stream.html">MirBufferStream</a>* bs = <a name="a29"></a><a class="code" href="group__mir__toolkit.html#ga407a1d750acb6287c34dae66e0b0110a">mir_render_surface_get_buffer_stream</a>(rs, width, height, pixel_format);</div><div class="line"></div><div class="line">    <span class="comment">// We can keep exchanging the current buffer for a new one</span></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; buffer_swap_count; i++)</div><div class="line">    {</div><div class="line">        <span class="comment">// We can query the current graphics buffer attributes</span></div><div class="line">        {</div><div class="line">            <a name="_a30"></a><a class="code" href="struct_mir_graphics_region.html">MirGraphicsRegion</a> graphics_region;</div><div class="line">            <a name="a31"></a><a class="code" href="group__mir__toolkit.html#ga6c54bc0a696f339c04cbd20e5c92bb09">mir_buffer_stream_get_graphics_region</a>(bs, &amp;graphics_region);</div><div class="line"></div><div class="line">            <span class="comment">// In a real application we&#39;d render into the graphics_region</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <a name="a32"></a><a class="code" href="group__mir__toolkit.html#ga3f25d60d431f9bd8140f9c65c0cb50cc">mir_buffer_stream_swap_buffers_sync</a>(bs);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// We should release our surface</span></div><div class="line">    <a name="a33"></a><a class="code" href="group__mir__toolkit.html#gaa7b7e2e8e8eda38ff03bc9ea34833d76">mir_window_release_sync</a>(mcd.window);</div><div class="line">    puts(<span class="stringliteral">&quot;Window released&quot;</span>);</div><div class="line"></div><div class="line">    <a name="a34"></a><a class="code" href="group__mir__toolkit.html#ga531312e5f8cd58b5c402aa386d4ea9a9">mir_render_surface_release</a>(rs);</div><div class="line"></div><div class="line">    <span class="comment">// We should release our connection</span></div><div class="line">    <a name="a35"></a><a class="code" href="group__mir__toolkit.html#ga50872f3adae37463ae2543cb5adab7e9">mir_connection_release</a>(mcd.connection);</div><div class="line">    puts(<span class="stringliteral">&quot;Connection released&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// The main() function deals with parsing arguments and defaults</span></div><div class="line"><span class="keywordtype">int</span> <a name="a36"></a><a class="code" href="basic_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div><div class="line">{</div><div class="line">    <span class="comment">// Some variables for holding command line options</span></div><div class="line">    <span class="keywordtype">char</span> <span class="keyword">const</span> *server = NULL;</div><div class="line">    <span class="keywordtype">int</span> buffer_swap_count = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Parse the command line</span></div><div class="line">    {</div><div class="line">        <span class="keywordtype">int</span> arg;</div><div class="line">        opterr = 0;</div><div class="line">        <span class="keywordflow">while</span> ((arg = getopt (argc, argv, <span class="stringliteral">&quot;c:hm:&quot;</span>)) != -1)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">switch</span> (arg)</div><div class="line">            {</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div><div class="line">                buffer_swap_count = atoi(optarg);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div><div class="line">                server = optarg;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div><div class="line">            <span class="keywordflow">default</span>:</div><div class="line">                puts(argv[0]);</div><div class="line">                puts(<span class="stringliteral">&quot;Usage:&quot;</span>);</div><div class="line">                puts(<span class="stringliteral">&quot;    -m &lt;Mir server socket&gt;&quot;</span>);</div><div class="line">                puts(<span class="stringliteral">&quot;    -h: this help text&quot;</span>);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="basic_8c.html#ab8531ab282a4e7c02c77e120fe652b2f">demo_client</a>(server, buffer_swap_count);</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<hr>
<p align="center">Copyright &copy; 2012-2017
 Canonical Ltd. <br />
Generated on czw, 28 wrz 2017, 12:44:51 UTC
</p>
</body>
</html>
