<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mir: server_example.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Mir
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">server_example.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>A simple server illustrating several customisations</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Copyright Â© 2012-2017 Canonical Ltd.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This program is free software: you can redistribute it and/or modify</span></div><div class="line"><span class="comment"> * it under the terms of the GNU General Public License version 2 or 3 as</span></div><div class="line"><span class="comment"> * published by the Free Software Foundation.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This program is distributed in the hope that it will be useful,</span></div><div class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><span class="comment"> * GNU General Public License for more details.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></div><div class="line"><span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Authored by: Alan Griffiths &lt;alan@octopull.co.uk&gt;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="server__example__log__options_8h.html">server_example_log_options.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="server__example__input__event__filter_8h.html">server_example_input_event_filter.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="server__example__input__filter_8h.html">server_example_input_filter.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="server__example__host__lifecycle__event__listener_8h.html">server_example_host_lifecycle_event_listener.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="server__example__custom__compositor_8h.html">server_example_custom_compositor.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="server__example__test__client_8h.html">server_example_test_client.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="server__example__input__device__config_8h.html">server_example_input_device_config.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tiling__window__manager_8h.html">miral-shell/tiling_window_manager.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="floating__window__manager_8h.html">miral-shell/floating_window_manager.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="titlebar__config_8h.html">miral-shell/titlebar_config.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="splash_8h.html">miral-shell/spinner/splash.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cursor__theme_8h.html">miral/cursor_theme.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="display__configuration__option_8h.html">miral/display_configuration_option.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="runner_8h.html">miral/runner.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="window__management__options_8h.html">miral/window_management_options.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="abnormal__exit_8h.html">mir/abnormal_exit.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;mir/server.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;mir/main_loop.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;mir/report_exception.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="option_8h.html">mir/options/option.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;boost/exception/diagnostic_information.hpp&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cstdlib&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespacemir.html">mir</a> { <span class="keyword">class </span>AbnormalExit; }</div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespacemir_1_1examples.html">me</a> = <a class="code" href="namespacemir_1_1examples.html">mir::examples</a>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">namespace</span></div><div class="line">{</div><div class="line"><span class="keywordtype">void</span> add_timeout_option_to(mir::Server&amp; server)</div><div class="line">{</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keyword">const</span> timeout_opt = <span class="stringliteral">&quot;timeout&quot;</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keyword">const</span> timeout_descr = <span class="stringliteral">&quot;Seconds to run before exiting&quot;</span>;</div><div class="line"></div><div class="line">    server.add_configuration_option(timeout_opt, timeout_descr, mir::OptionType::integer);</div><div class="line"></div><div class="line">    server.add_init_callback([&amp;server]</div><div class="line">    {</div><div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> options = server.get_options();</div><div class="line">        <span class="keywordflow">if</span> (options-&gt;is_set(timeout_opt))</div><div class="line">        {</div><div class="line">            <span class="keyword">static</span> <span class="keyword">auto</span> <span class="keyword">const</span> exit_action = server.the_main_loop()-&gt;create_alarm([&amp;server] { server.stop(); });</div><div class="line">            exit_action-&gt;reschedule_in(std::chrono::seconds(options-&gt;get&lt;<span class="keywordtype">int</span>&gt;(timeout_opt)));</div><div class="line">        }</div><div class="line">    });</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Create some input filters (we need to keep them or they deactivate)</span></div><div class="line"><span class="keyword">struct </span>InputFilters</div><div class="line">{</div><div class="line">    <span class="keywordtype">void</span> operator()(mir::Server&amp; server)</div><div class="line">    {</div><div class="line">        quit_filter = <a name="a0"></a><a class="code" href="namespacemir_1_1examples.html#a5049da6c8cdb4ecff272ca942603857e">me::make_quit_filter_for</a>(server);</div><div class="line">        printing_filter = <a name="a1"></a><a class="code" href="namespacemir_1_1examples.html#acae77ff5d35c658b9c994db2b64c3999">me::make_printing_input_filter_for</a>(server);</div><div class="line">        screen_rotation_filter = <a name="a2"></a><a class="code" href="namespacemir_1_1examples.html#a103c66da2f460d61e24f7dccc9717df6">me::make_screen_rotation_filter_for</a>(server);</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    std::shared_ptr&lt;mir::input::EventFilter&gt; quit_filter;</div><div class="line">    std::shared_ptr&lt;mir::input::EventFilter&gt; printing_filter;</div><div class="line">    std::shared_ptr&lt;mir::input::EventFilter&gt; screen_rotation_filter;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> exception_handler()</div><div class="line"><span class="keyword">try</span></div><div class="line">{</div><div class="line">    <span class="keywordflow">throw</span>;</div><div class="line">}</div><div class="line"><span class="keywordflow">catch</span> (<a name="_a3"></a><a class="code" href="classmir_1_1_abnormal_exit.html">mir::AbnormalExit</a> <span class="keyword">const</span>&amp; <span class="comment">/*error*/</span>)</div><div class="line">{</div><div class="line">}</div><div class="line"><span class="keywordflow">catch</span> (std::exception <span class="keyword">const</span>&amp; <a class="code" href="namespacemir_1_1dispatch.html#a1193057c5af0cf923bb4090e7baad1cfa8fafb02ca3c9ad270f620b56400b8b5b">error</a>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">char</span> <span class="keyword">const</span> command_fmt[] = <span class="stringliteral">&quot;/usr/share/apport/recoverable_problem --pid %d&quot;</span>;</div><div class="line">    <span class="keywordtype">char</span> command[<span class="keyword">sizeof</span>(command_fmt)+32];</div><div class="line">    snprintf(command, <span class="keyword">sizeof</span>(command), command_fmt, getpid());</div><div class="line">    <span class="keywordtype">char</span> <span class="keyword">const</span> options[] = <span class="stringliteral">&quot;we&quot;</span>;</div><div class="line">    <span class="keywordtype">char</span> <span class="keyword">const</span> key[] = <span class="stringliteral">&quot;UnhandledException&quot;</span>;</div><div class="line">    <span class="keyword">auto</span> <span class="keyword">const</span> value = boost::diagnostic_information(error);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<span class="keyword">auto</span> <span class="keyword">const</span> output = popen(command, options))</div><div class="line">    {</div><div class="line">        fwrite(key, <span class="keyword">sizeof</span>(key), 1, output);            <span class="comment">// the null terminator is used intentionally as a separator</span></div><div class="line">        fwrite(value.c_str(), value.size(), 1, output);</div><div class="line">        pclose(output);</div><div class="line">    }</div><div class="line"></div><div class="line">    mir::report_exception();</div><div class="line">}</div><div class="line"><span class="keywordflow">catch</span> (...)</div><div class="line">{</div><div class="line">    mir::report_exception();</div><div class="line">}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a4"></a><a class="code" href="server__example_8cpp.html#abf9e6b7e6f15df4b525a2e7705ba3089">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> <span class="keyword">const</span>* argv[])</div><div class="line"><span class="keyword">try</span></div><div class="line">{</div><div class="line">    <a name="_a5"></a><a class="code" href="classmiral_1_1_mir_runner.html">miral::MirRunner</a> runner{argc, argv, <span class="stringliteral">&quot;mir/mir_demo_server.config&quot;</span>};</div><div class="line"></div><div class="line">    runner.<a name="a6"></a><a class="code" href="classmiral_1_1_mir_runner.html#abdbf58b0d770a5ecabc4db16848becac">set_exception_handler</a>(exception_handler);</div><div class="line"></div><div class="line">    std::function&lt;void()&gt; shutdown_hook{[]{}};</div><div class="line">    runner.add_stop_callback([&amp;] { shutdown_hook(); });</div><div class="line"></div><div class="line">    <a name="_a7"></a><a class="code" href="class_spinner_splash.html">SpinnerSplash</a> spinner;</div><div class="line">    <a name="_a8"></a><a class="code" href="classmiral_1_1_internal_client_launcher.html">miral::InternalClientLauncher</a> launcher;</div><div class="line">    <a name="_a9"></a><a class="code" href="classmiral_1_1_active_outputs_monitor.html">miral::ActiveOutputsMonitor</a> outputs_monitor;</div><div class="line">    <a name="_a10"></a><a class="code" href="classmiral_1_1_window_manager_options.html">miral::WindowManagerOptions</a> window_managers</div><div class="line">        {</div><div class="line">            miral::add_window_manager_policy&lt;FloatingWindowManagerPolicy&gt;(<span class="stringliteral">&quot;floating&quot;</span>, spinner, launcher, shutdown_hook),</div><div class="line">            miral::add_window_manager_policy&lt;TilingWindowManagerPolicy&gt;(<span class="stringliteral">&quot;tiling&quot;</span>, spinner, launcher, outputs_monitor),</div><div class="line">        };</div><div class="line"></div><div class="line">    InputFilters input_filters;</div><div class="line">    <a class="code" href="namespaceme_1_1_test_client_runner.html">me::TestClientRunner</a> test_runner;</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> <span class="keyword">const</span> server_exited_normally = runner.run_with({</div><div class="line">        <span class="comment">// example options for display layout, logging and timeout</span></div><div class="line">        <a name="a11"></a><a class="code" href="namespacemiral.html#a7a992b36731bb6543092e39776640ba8">miral::display_configuration_options</a>,</div><div class="line">        <a name="a12"></a><a class="code" href="namespacemir_1_1examples.html#a5d6223fe24394b94588f3e381987b26b">me::add_log_host_lifecycle_option_to</a>,</div><div class="line">        <a name="a13"></a><a class="code" href="namespacemir_1_1examples.html#aede0e37dce2c6a83b2e977fdc2a215b0">me::add_glog_options_to</a>,</div><div class="line">        <a name="_a14"></a><a class="code" href="classmiral_1_1_startup_internal_client.html">miral::StartupInternalClient</a>{<span class="stringliteral">&quot;Intro&quot;</span>, spinner},</div><div class="line">        launcher,</div><div class="line">        window_managers,</div><div class="line">        <a name="a15"></a><a class="code" href="namespacemir_1_1examples.html#a024244343c310e74fd43658ac36687e4">me::add_custom_compositor_option_to</a>,</div><div class="line">        <a name="a16"></a><a class="code" href="namespacemir_1_1examples.html#a5ebc04c644a0e2adc32f25eb7bb49489">me::add_input_device_configuration_options_to</a>,</div><div class="line">        add_timeout_option_to,</div><div class="line">        <a name="_a17"></a><a class="code" href="classmiral_1_1_cursor_theme.html">miral::CursorTheme</a>{<span class="stringliteral">&quot;default&quot;</span>},</div><div class="line">        input_filters,</div><div class="line">        test_runner</div><div class="line">    });</div><div class="line"></div><div class="line">    <span class="comment">// Propagate any test failure</span></div><div class="line">    <span class="keywordflow">if</span> (test_runner.<a name="a18"></a><a class="code" href="classmir_1_1examples_1_1_test_client_runner.html#a690841d74c697b9835bd4d49e3fab008">test_failed</a>())</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> EXIT_FAILURE;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> server_exited_normally ? EXIT_SUCCESS : EXIT_FAILURE;</div><div class="line">}</div><div class="line"><span class="keywordflow">catch</span> (...)</div><div class="line">{</div><div class="line">    mir::report_exception();</div><div class="line">    <span class="keywordflow">return</span> EXIT_FAILURE;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<hr>
<p align="center">Copyright &copy; 2012-2017
 Canonical Ltd. <br />
Generated on czw, 28 wrz 2017, 12:44:51 UTC
</p>
</body>
</html>
